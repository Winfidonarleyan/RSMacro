import oralib, likepy, rsd, rslscr, globals;

private macro GetClientCode(): Integer
  var clientID = 0;
  GetInt(clientID, "������ ��� ������");
  return clientID;
end;

private macro GetClientCodeScroll() : Integer
  var cmd = RsdCommand("select t_client, t_nameaccount, t_Account from daccount_dbt");
  var ob = RsdRecordset(cmd, RSDVAL_CLIENT, RSDVAL_STATIC);

  macro SMsgProc(ob, cmd, id, key)
    if (cmd == DLG_KEY)
      if (key == 13)
        return CM_SELECT;
      end;
    end;
  end;

  if (RunScroll(ob, 0, null, "ChooseClientID", @SMsgProc, "�롮� ������", "", false, -1, -1, 60, 30))
    return ob.value(0);
  end;
end;

class ClientInfo(id: Integer)
  private var name, fullName;
  private var clientID = id;
  private var isExistClinet = false;

  private macro GetRSDParty()
    var query = RsdRecordset(String("select t_shortname, t_name from dparty_dbt where t_partyid = ", clientID));

    if (query.moveNext())
      name = query.value(0);
      fullName = query.value(1);
      isExistClinet = true;
    end;
  end;

  macro PrintNames()
    PrintLn("������ ������������: ", fullName);
    PrintLn("��⪮� ������������: ", name);
  end;

  macro PrintInn()
    if (isExistClinet == false)
      return;
    end;

    private var Inn = "-";
    private var Kpp = "-";

    SplitFullINN(GetPartyINN(clientID, 1), Inn, Kpp);

    if (Inn != "")
      PrintLn("���: ", Inn);
    end;

    if (Kpp != "")
      PrintLn("���: ", Kpp);
    end;
  end;

  macro PrintOGRN()
    var OGRN = "-";
    var q = " SELECT t_code                                            "+
            "   FROM dobjcode_dbt                                      "+
            "  WHERE t_ObjectType = 3                                  "+
            "       AND t_ObjectID = :PartyID                          "+
            "       AND t_CodeKind = 27                                "+
            "       AND t_BankCloseDate=to_date('01010001','ddmmyyyy') ";

    var params = makeArray(SQLParam("PartyID", clientID));
    var rs = execSQLselect(q, params, TRUE);

    if (rs.moveNext())
      OGRN = Trim(rs.value("t_code"));
      PrintLn("����: ", OGRN)
    end;
  end;

  macro PrintAdress()
    var queryAdress = RsdRecordset(String("SELECT t.T_ADRESS, tp.T_NAME FROM DADRESS_DBT t, DADRTYPE_DBT tp WHERE T_PARTYID = ", clientID, " and TP.T_TYPE = T.T_TYPE"));

    if (queryAdress.moveNext())
      PrintLn(queryAdress.value(1), " ����: ", queryAdress.value(0));
    end;
  end;

  macro PrintContact()
    var queryPhone = RsdRecordset(String("SELECT t.T_VALUE, tp.T_NAME FROM DCONTACT_DBT t, DCONTACTTYPE_DBT tp WHERE T_PARTYID = ", clientID, " AND TP.T_TYPE = T.T_CONTACTTYPE"));

    if (queryPhone.moveNext())
      PrintLn(queryPhone.value(1), ": ", queryPhone.value(0));
    end;
  end;

  macro PrintInfo()
    if (isExistClinet == false)
      PrintLn("��� ���ଠ樨 �� ������� � �����: ", clientID);
      PrintLn("������ ������ �� �������, ���� �� 㪠���� ������ ���");
      return;
    end;

    PrintLn("���ଠ�� �� ������� � �����: ", clientID);

    PrintNames();
    PrintInn();
    PrintOGRN();
    PrintAdress();
    PrintContact();
  end;

  /* After init check if exist*/
  GetRSDParty();
end;

class ClientInfoAccount()
  var ID, AccountID, Chapter, AccountStatus, Money, CurrencyName, CurrencyCode: Integer;

  private macro UpdateCurrencyByCode(code: Integer)
    var queryCurrency = RsdRecordset(String("select t_short_name, t_externalcode from dcurrency_dbt where t_code_currency = ", code));

    if (queryCurrency.moveNext())
      CurrencyName = queryCurrency.value(0);
      CurrencyCode = queryCurrency.value(1);
    end;
  end;

  private macro GetMoney(code: Integer) : Money
    var moneyCount = $0;
    var accountFreeRest = $0;
    var params:TArray;
    var rs:object;

    var select = "select nvl(sum(ch.t_Uselimit - ch.t_ReconstructionLimit), 0) "
                 "from dcredit_c_dbt cred, dovc_sfc_dbt ovc, dchlimit_dbt ch "
                 "where cred.t_creditnumber = ovc.t_creditnumber_ref "
                 "and cred.t_regdate <= :date1 "
                 "and cred.t_ReturnDate >= :date2 "
                 "and ch.t_CreditNumber_Ref = cred.t_CreditNumber "
                 "and ch.t_IsProcessing = chr(0) "
                 "and ch.t_Date = :date3 "
                 "and ch.t_IsReject = chr(0) "
                 "and ovc.t_id = ( select sf.t_ID "
                 "from dsfcontr_dbt sf "
                 "where sf.t_ServKind = 3 "
                 "and sf.t_ObjectType = 1 "
                 "and sf.t_FIID = :fiid "
                 "and sf.t_Object = :acc "
                 "and t_DateBegin <= :date4 "
                 "and (t_DateClose >= :date5 OR t_DateClose = to_date('01010001','ddmmyyyy')))";

    params = makeArray(SQLParam("date1", {curdate}),
                       SQLParam("date2", {curdate}),
                       SQLParam("date3", {curdate}),
                       SQLParam("fiid",  code),
                       SQLParam("acc",   ID),
                       SQLParam("date4", {curdate}),
                       SQLParam("date5", {curdate}));

    rs = execSQLselect(select, params, FALSE);

    if (AccGetFreeAmount(accountFreeRest, NULL, ID, Chapter, code, {curdate}))
      PrintLn("�訡�� �� ��।������ ᢮������� ���⪠ ��� ���� '", ID, "'");
    end;

    if (rs.moveNext())
      moneyCount = AccountFreeRest + rs.value(0);

      /* Debug acc money
        PrintLn("> AccountFreeRest = ", AccountFreeRest);
        PrintLn("> rs.value(0) = ", rs.value(0));
      */
    end;

    return moneyCount;
  end;

  macro Update(updateQuery)
    UpdateCurrencyByCode(updateQuery.value(1));

    ID = updateQuery.value(0);
    AccountStatus = updateQuery.value(2);
    Chapter = updateQuery.value(3);
    AccountID = updateQuery.value(4);
    Money = GetMoney(updateQuery.value(1));
  end;

  macro PrintLineTable(client: ClientInfoAccount, isNeedPrintHeader)
    if (isNeedPrintHeader)
      var headTable = "��������������������������������������������������������������������������������\n" +
                      "�       ����� ����      �   ����� ���   �   �����   �   ����騩 ���⮪   �";

      PrintLn("\n��� ������:");
      PrintLn(headTable);
    end;

    PrintLn("������������������������������������������������������������������������������Ĵ");
    [�  ####################  �        ########  �   ######   �  ###########        �]
    (ID, CurrencyName, AccountStatus, Money);
  end;
end;

private macro PrintBaseClientInfo(clientID: Integer)
  var info = ClientInfo(clientID);

  info.PrintInfo();
end;

private macro PrintAccountClientInfo(clientID: Integer)
  /*                                              0                1             2          3            4 */
  var query = RsdRecordset(String("select t_Account, t_code_currency, CASE when t_open_close = chr(0) THEN '�����' else '������' end, t_chapter, t_accountid from daccount_dbt where t_Client = ", clientID));

  if (query.moveNext())
    var accCount = 1;
    var accInfo = ClientInfoAccount();

    accInfo.Update(query);
    accInfo.PrintLineTable(accInfo, true);

    while (query.moveNext())
      accInfo.Update(query);
      accInfo.PrintLineTable(accInfo);
      accCount = accCount + 1;
    end;

    PrintLn("��������������������������������������������������������������������������������");
    PrintLn("������⢮ ��⮢: ", accCount);
  end;
end;

private macro PrintAllClientInfo()
  var clientID = GetClientCode();
  /*var clientID = GetClientCodeScroll();*/

  PrintBaseClientInfo(clientID);
  PrintAccountClientInfo(clientID);
end;

/* Init */
PrintAllClientInfo();
